<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ö–ë–ñ–£ –±–ª—é–¥</title>

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          Cantarell, sans-serif;
        padding: 20px;
        background: linear-gradient(135deg, #ff6b9d 0%, #ff8fab 100%);
        min-height: 100vh;
        color: #333;
      }
      .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      h2 {
        text-align: center;
        margin-bottom: 16px;
        color: #d63384;
        font-weight: 700;
        font-size: 24px;
      }
      .subtitle {
        text-align: center;
        color: #e64980;
        margin-bottom: 24px;
        font-size: 14px;
        font-weight: 500;
      }
      .section {
        margin-bottom: 20px;
      }
      .section-title {
        font-weight: 600;
        margin-bottom: 12px;
        color: #c2255c;
        font-size: 16px;
      }
      .row {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        align-items: center;
      }
      input, select {
        flex: 1;
        padding: 12px;
        border: 2px solid #fcc2d7;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s;
        background: #fff5f7;
      }
      input:focus, select:focus {
        outline: none;
        border-color: #e64980;
        box-shadow: 0 0 0 3px rgba(230, 73, 128, 0.1);
        background: white;
      }
      .ingredient-input {
        flex: 2;
      }
      .weight-input {
        flex: 1;
        text-align: center;
      }
      .unit-select {
        flex: 0.7;
      }
      .unit {
        color: #e64980;
        font-size: 14px;
        min-width: 30px;
        font-weight: 500;
      }
      .btn {
        width: 100%;
        padding: 14px;
        font-size: 16px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .btn-primary {
        background: linear-gradient(135deg, #e64980 0%, #c2255c 100%);
        color: white;
      }
      .btn-secondary {
        background: #fcc2d7;
        color: #c2255c;
        border: 2px solid #faa2c1;
      }
      .btn-template {
        background: linear-gradient(135deg, #74c0fc 0%, #4dabf7 100%);
        color: white;
      }
      .btn:disabled {
        background: #dee2e6;
        color: #adb5bd;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .delete-btn {
        background: #ffe3e3;
        color: #fa5252;
        border: 2px solid #ffc9c9;
        border-radius: 10px;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
        transition: all 0.3s;
      }
      .final-weight-section {
        background: #fff0f6;
        padding: 20px;
        border-radius: 16px;
        margin: 20px 0;
        border: 2px solid #fcc2d7;
      }
      .info-text {
        background: #e3fafc;
        border: 2px solid #99e9f2;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #0c8599;
      }
      .error {
        background: #ffe3e3;
        border: 2px solid #ffa8a8;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #c92a2a;
        display: none;
      }
      .success {
        background: #d3f9d8;
        border: 2px solid #8ce99a;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
        font-size: 14px;
        color: #2b8a3e;
        display: none;
      }
      .ingredient-example {
        font-size: 12px;
        color: #e64980;
        margin-top: 6px;
        font-style: italic;
      }
      .template-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .template-buttons .btn {
        flex: 1;
        margin-bottom: 0;
      }
      .autocomplete-box {
        position: absolute;
        z-index: 1000;
        background: #fff;
        border: 1px solid #eee;
        max-height: 180px;
        overflow-y: auto;
        width: 100%;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        top: 100%;
        left: 0;
        margin-top: 2px;
      }
      .autocomplete-item {
        padding: 8px 10px;
        font-size: 14px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
      }
      .autocomplete-item:hover {
        background: #f8f9fa;
      }
      .calculation-section {
        background: #fff0f6;
        padding: 20px;
        border-radius: 16px;
        margin: 20px 0;
        border: 2px solid #fcc2d7;
      }
      .copy-btn {
        background: #4dabf7;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 12px;
        margin-left: 10px;
      }
      .nutrition-info {
        background: #e3fafc;
        border: 2px solid #99e9f2;
        border-radius: 12px;
        padding: 16px;
        margin: 10px 0;
      }
      .nutrition-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .nutrition-value {
        font-weight: 600;
        color: #c2255c;
      }
      @media (max-width: 480px) {
        .container {
          padding: 16px;
          margin: 10px;
        }
        .row {
          flex-direction: column;
          gap: 8px;
        }
        input, select {
          width: 100%;
        }
        .template-buttons {
          flex-direction: column;
        }
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  </head>

  <body>
    <div class="container">
      <h2>üçΩÔ∏è –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ö–ë–ñ–£</h2>
      <div class="subtitle">–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ nutritional values –≤–∞—à–∏—Ö –±–ª—é–¥</div>

      <div class="info-text">
        üí´ <strong>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong> –î–æ–±–∞–≤—å—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã, —É–∫–∞–∂–∏—Ç–µ –≤–µ—Å –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞, 
        –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Ä—Ü–∏–π.
      </div>

      <div class="error" id="errorMessage"></div>
      <div class="success" id="successMessage"></div>

      <div class="section">
        <div class="section-title">üìã –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</div>
        <div class="ingredient-example">
          –ü—Ä–∏–º–µ—Ä: "–≥—Ä–µ—á–∫–∞", "–∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞", "–æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ"
        </div>

        <div id="rowsContainer">
          <!-- –°—Ç—Ä–æ–∫–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>

        <button type="button" class="btn btn-secondary" id="addRowBtn">
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç
        </button>
      </div>

      <div class="final-weight-section">
        <div class="section-title">‚öñÔ∏è –í–µ—Å –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞</div>
        <input
          type="number"
          id="finalWeight"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö"
          min="1"
          class="weight-input"
        />
        <div class="ingredient-example">
          –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ! –£—á–∏—Ç—ã–≤–∞–µ—Ç —É–≤–∞—Ä–∫—É/—É–∂–∞—Ä–∫—É –ø—Ä–æ–¥—É–∫—Ç–æ–≤
        </div>
      </div>

      <div class="calculation-section">
        <div class="section-title">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–æ—Ä—Ü–∏–π</div>
        
        <div style="margin-bottom: 15px;">
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="number" id="portionWeight" placeholder="–í–µ—Å –ø–æ—Ä—Ü–∏–∏ (–≥)" style="flex: 1;">
            <button class="btn btn-primary" id="calculatePortionBtn" style="flex: 1;">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ö–ë–ñ–£ –ø–æ—Ä—Ü–∏–∏</button>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <input type="number" id="targetCalories" placeholder="–¶–µ–ª–µ–≤—ã–µ –∫–∞–ª–æ—Ä–∏–∏" style="flex: 1;">
            <button class="btn btn-primary" id="calculateWeightBtn" style="flex: 1;">–ù–∞–π—Ç–∏ –≤–µ—Å –ø–æ—Ä—Ü–∏–∏</button>
          </div>
        </div>

        <div id="calculationResult" style="display: none;">
          <div class="nutrition-info">
            <div class="nutrition-row">
              <span>–ö–∞–ª–æ—Ä–∏–∏:</span>
              <span class="nutrition-value" id="resultCalories">0</span>
            </div>
            <div class="nutrition-row">
              <span>–ë–µ–ª–∫–∏:</span>
              <span class="nutrition-value" id="resultProtein">0 –≥</span>
            </div>
            <div class="nutrition-row">
              <span>–ñ–∏—Ä—ã:</span>
              <span class="nutrition-value" id="resultFat">0 –≥</span>
            </div>
            <div class="nutrition-row">
              <span>–£–≥–ª–µ–≤–æ–¥—ã:</span>
              <span class="nutrition-value" id="resultCarbs">0 –≥</span>
            </div>
            <div class="nutrition-row">
              <span>–í–µ—Å –ø–æ—Ä—Ü–∏–∏:</span>
              <span class="nutrition-value" id="resultWeight">0 –≥</span>
            </div>
            <button class="copy-btn" id="copyResultsBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>
      </div>

      <button type="button" class="btn btn-primary" id="calculateDishBtn">
        üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ö–ë–ñ–£ –±–ª—é–¥–∞
      </button>

      <div class="template-buttons">
        <button type="button" class="btn btn-template" id="saveTemplateBtn">
          üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω
        </button>
        <button type="button" class="btn btn-template" id="myTemplatesBtn">
          üìã –ú–æ–∏ —à–∞–±–ª–æ–Ω—ã
        </button>
      </div>
    </div>

    <script>
      // ====== –ë–ê–ó–ê –ü–†–û–î–£–ö–¢–û–í –° –ö–ë–ñ–£ ======
      const productsDB = {
        "–≥—Ä–µ—á–∫–∞": {"calories": 343, "protein": 13, "fat": 3.4, "carbs": 72, "type": "raw"},
        "–∫—É—Ä–∏—Ü–∞": {"calories": 165, "protein": 31, "fat": 3.6, "carbs": 0, "type": "raw"},
        "–∫–∞—Ä—Ç–æ—à–∫–∞": {"calories": 77, "protein": 2, "fat": 0.1, "carbs": 17, "type": "raw"},
        "–º–æ—Ä–∫–æ–≤—å": {"calories": 41, "protein": 0.9, "fat": 0.2, "carbs": 10, "type": "raw"},
        "–ª—É–∫": {"calories": 40, "protein": 1.1, "fat": 0.1, "carbs": 9, "type": "raw"},
        "—Ç–≤–æ—Ä–æ–≥": {"calories": 121, "protein": 17, "fat": 5, "carbs": 2, "type": "raw"},
        "—è–±–ª–æ–∫–æ": {"calories": 52, "protein": 0.3, "fat": 0.2, "carbs": 14, "type": "raw"},
        "–±–∞–Ω–∞–Ω": {"calories": 89, "protein": 1.1, "fat": 0.3, "carbs": 23, "type": "raw"},
        "–º–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ": {"calories": 884, "protein": 0, "fat": 100, "carbs": 0, "type": "processed"},
        "—Å–æ–ª—å": {"calories": 0, "protein": 0, "fat": 0, "carbs": 0, "type": "raw"}
      };

      // ====== –®–¢–£–ß–ù–´–ï –ü–†–û–î–£–ö–¢–´ ======
      const pieceProducts = {
        '—è–π—Ü–æ': 50, '—è–π—Ü–æ –∫—É—Ä–∏–Ω–æ–µ': 50, '—è–π—Ü–æ –ø–µ—Ä–µ–ø–µ–ª–∏–Ω–æ–µ': 10,
        '—è–±–ª–æ–∫–æ': 150, '–±–∞–Ω–∞–Ω': 120, '–∞–ø–µ–ª—å—Å–∏–Ω': 200, '–≥—Ä—É—à–∞': 180,
        '–ø–µ—Ä—Å–∏–∫': 150, '–Ω–µ–∫—Ç–∞—Ä–∏–Ω': 140, '—Å–ª–∏–≤–∞': 40, '–∫–∏–≤–∏': 75,
        '–º–∞–Ω–¥–∞—Ä–∏–Ω': 80, '–ª–∏–º–æ–Ω': 120, '–ª–∞–π–º': 70, '–∞–≤–æ–∫–∞–¥–æ': 200,
        '–æ–≥—É—Ä–µ—Ü': 150, '–ø–æ–º–∏–¥–æ—Ä': 150, '–ø–µ—Ä–µ—Ü –±–æ–ª–≥–∞—Ä—Å–∫–∏–π': 200,
        '–∫–∞—Ä—Ç–æ—à–∫–∞': 100, '—Ä–µ–¥–∏—Å': 20, '—Å–≤–µ–∫–ª–∞': 200,
        '–º–æ—Ä–∫–æ–≤—å': 100, '–ª—É–∫': 100, '—á–µ—Å–Ω–æ–∫': 10, '–∏–º–±–∏—Ä—å': 50
      };

      // ====== DOM ELEMENTS ======
      const rowsContainer = document.getElementById("rowsContainer");
      const addRowBtn = document.getElementById("addRowBtn");
      const calculateDishBtn = document.getElementById("calculateDishBtn");
      const saveTemplateBtn = document.getElementById("saveTemplateBtn");
      const myTemplatesBtn = document.getElementById("myTemplatesBtn");
      const finalWeightInput = document.getElementById("finalWeight");
      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");
      const calculatePortionBtn = document.getElementById("calculatePortionBtn");
      const calculateWeightBtn = document.getElementById("calculateWeightBtn");
      const portionWeightInput = document.getElementById("portionWeight");
      const targetCaloriesInput = document.getElementById("targetCalories");
      const calculationResult = document.getElementById("calculationResult");
      const copyResultsBtn = document.getElementById("copyResultsBtn");

      // ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FUSE ======
      const fuse = new Fuse(Object.keys(productsDB), {
        includeScore: true,
        threshold: 0.35,
        distance: 100,
        minMatchCharLength: 1,
      });

      // ====== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ======
      let rowCounter = 0;
      let processedProductsCount = 0;
      const TEMPLATES_KEY = "kbj_templates_v1";

      // ====== –§–£–ù–ö–¶–ò–ò ======
      function showMessage(element, message, timeout = 4000) {
        if (!element) return;
        element.textContent = message;
        element.style.display = "block";
        setTimeout(() => {
          element.style.display = "none";
        }, timeout);
      }

      function escapeHtml(text) {
        if (text === null || text === undefined) return "";
        return String(text)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function addRow(ingredient = "", weight = "", unit = "–≥") {
        rowCounter++;
        const rowId = `row-${rowCounter}`;
        const rowDiv = document.createElement("div");
        rowDiv.className = "row";
        rowDiv.id = rowId;

        const isPieceProduct = pieceProducts.hasOwnProperty(ingredient.toLowerCase());
        const defaultWeight = isPieceProduct ? "1" : weight;

        rowDiv.innerHTML = `
          <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞" class="ingredient-input ing" value="${escapeHtml(ingredient)}" />
          <select class="unit-select unit" data-row-id="${rowId}">
            <option value="–≥" ${unit === "–≥" ? "selected" : ""}>–≥</option>
            <option value="—à—Ç" ${unit === "—à—Ç" ? "selected" : ""}>—à—Ç</option>
          </select>
          <input type="number" placeholder="–í–µ—Å" class="weight-input weight" value="${escapeHtml(defaultWeight)}" min="1" />
          <div class="unit">${unit === "—à—Ç" ? "—à—Ç" : "–≥"}</div>
          <button type="button" class="delete-btn" data-row-id="${rowId}" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
        `;
        rowsContainer.appendChild(rowDiv);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        const deleteBtn = rowDiv.querySelector(".delete-btn");
        deleteBtn.addEventListener("click", function () {
          removeRow(this.getAttribute("data-row-id"));
        });

        const unitSelect = rowDiv.querySelector(".unit-select");
        const weightInput = rowDiv.querySelector(".weight");
        const unitDisplay = rowDiv.querySelector(".unit:last-child");

        unitSelect.addEventListener("change", function() {
          const selectedUnit = this.value;
          unitDisplay.textContent = selectedUnit === "—à—Ç" ? "—à—Ç" : "–≥";
          
          // –ê–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ—Å–∞ –¥–ª—è —à—Ç—É—á–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
          const ingInput = this.parentElement.querySelector(".ing");
          const productName = ingInput.value.trim().toLowerCase();
          if (selectedUnit === "—à—Ç" && pieceProducts[productName]) {
            weightInput.value = "1";
          }
          validateForm();
        });

        const ingInput = rowDiv.querySelector(".ing");
        ingInput.addEventListener("input", function() {
          const productName = this.value.trim().toLowerCase();
          const unitSelect = this.parentElement.querySelector(".unit-select");
          
          // –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ "—à—Ç" –¥–ª—è —à—Ç—É—á–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
          if (pieceProducts[productName] && unitSelect.value === "–≥") {
            unitSelect.value = "—à—Ç";
            unitSelect.dispatchEvent(new Event('change'));
          }
          
          validateForm();
        });

        weightInput.addEventListener("input", validateForm);
        ingInput.addEventListener("input", validateForm);

        attachAutocompleteTo(ingInput);
        validateForm();
      }

      function removeRow(rowId) {
        const row = document.getElementById(rowId);
        if (row) {
          row.remove();
          validateForm();
          const existingRows = document.querySelectorAll(".row");
          if (existingRows.length === 0) addRow();
        }
      }

      function getIngredients() {
        const rows = document.querySelectorAll(".row");
        const arr = [];
        processedProductsCount = 0;

        rows.forEach((row) => {
          const ingredient = row.querySelector(".ing")?.value.trim();
          const weight = row.querySelector(".weight")?.value.trim();
          const unit = row.querySelector(".unit-select")?.value;

          if (ingredient && weight) {
            let finalWeight = parseFloat(weight);
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —à—Ç—É–∫ –≤ –≥—Ä–∞–º–º—ã
            if (unit === "—à—Ç" && pieceProducts[ingredient.toLowerCase()]) {
              finalWeight = parseFloat(weight) * pieceProducts[ingredient.toLowerCase()];
            }

            // –ü–æ–¥—Å—á–µ—Ç processed –ø—Ä–æ–¥—É–∫—Ç–æ–≤
            if (productsDB[ingredient] && productsDB[ingredient].type === "processed") {
              processedProductsCount++;
            }

            arr.push({ 
              ingredient, 
              grams: finalWeight,
              displayWeight: weight,
              unit: unit
            });
          }
        });
        return arr;
      }

      function validateForm() {
        const ingredients = getIngredients();
        const finalWeight = finalWeightInput.value.trim();
        let isValid = true;
        let errorText = "";

        if (ingredients.length === 0) {
          isValid = false;
          errorText = "–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç";
        } else {
          for (const ing of ingredients) {
            if (!ing.ingredient.trim()) {
              isValid = false;
              errorText = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤";
              break;
            }
            if (!ing.displayWeight || parseFloat(ing.displayWeight) <= 0) {
              isValid = false;
              errorText = "–í–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0 –¥–ª—è –≤—Å–µ—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤";
              break;
            }
          }
        }

        if (!finalWeight) {
          isValid = false;
          errorText = "–£–∫–∞–∂–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—ã–π –≤–µ—Å –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞";
        } else if (parseInt(finalWeight) <= 0) {
          isValid = false;
          errorText = "–ò—Ç–æ–≥–æ–≤—ã–π –≤–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ 0";
        }

        calculateDishBtn.disabled = !isValid;
        calculatePortionBtn.disabled = !isValid;
        calculateWeightBtn.disabled = !isValid;

        if (!isValid && errorText) {
          showMessage(errorMessage, errorText, 3000);
        } else {
          errorMessage.style.display = "none";
        }

        return isValid;
      }

      function calculateDishNutrition() {
        if (!validateForm()) return null;

        const ingredients = getIngredients();
        let totalCalories = 0;
        let totalProtein = 0;
        let totalFat = 0;
        let totalCarbs = 0;
        let totalWeight = 0;

        ingredients.forEach(ing => {
          const product = productsDB[ing.ingredient];
          if (product) {
            const ratio = ing.grams / 100;
            totalCalories += product.calories * ratio;
            totalProtein += product.protein * ratio;
            totalFat += product.fat * ratio;
            totalCarbs += product.carbs * ratio;
          }
          totalWeight += ing.grams;
        });

        return {
          calories: Math.round(totalCalories),
          protein: Math.round(totalProtein * 10) / 10,
          fat: Math.round(totalFat * 10) / 10,
          carbs: Math.round(totalCarbs * 10) / 10,
          totalWeight: Math.round(totalWeight)
        };
      }

      function calculatePortionNutrition() {
        if (!validateForm()) return;

        const portionWeight = parseFloat(portionWeightInput.value);
        if (!portionWeight || portionWeight <= 0) {
          showMessage(errorMessage, "–í–≤–µ–¥–∏—Ç–µ –≤–µ—Å –ø–æ—Ä—Ü–∏–∏");
          return;
        }

        const finalWeight = parseFloat(finalWeightInput.value);
        const nutrition = calculateDishNutrition();
        
        if (!nutrition) return;

        // –§–æ—Ä–º—É–ª–∞: (–≤–µ—Å –ø–æ—Ä—Ü–∏–∏ / –≤–µ—Å –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞) * –≤–µ—Å —Å—ã—Ä—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤
        const ratio = portionWeight / finalWeight;
        const portionRatio = ratio * nutrition.totalWeight;

        const result = {
          calories: Math.round(nutrition.calories * ratio),
          protein: Math.round(nutrition.protein * ratio * 10) / 10,
          fat: Math.round(nutrition.fat * ratio * 10) / 10,
          carbs: Math.round(nutrition.carbs * ratio * 10) / 10,
          weight: portionWeight
        };

        displayResults(result);
        
        // –ü–æ–∫–∞–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ processed –ø—Ä–æ–¥—É–∫—Ç–∞—Ö
        if (processedProductsCount > 0) {
          showMessage(successMessage, 
            `‚ö†Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–æ ${processedProductsCount} –ø—Ä–æ–¥—É–∫—Ç(–æ–≤) —Å —É—Å—Ä–µ–¥–Ω–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏. –§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ö–ë–ñ–£ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è.`,
            6000
          );
        }
      }

      function calculateWeightByCalories() {
        if (!validateForm()) return;

        const targetCalories = parseFloat(targetCaloriesInput.value);
        if (!targetCalories || targetCalories <= 0) {
          showMessage(errorMessage, "–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤—ã–µ –∫–∞–ª–æ—Ä–∏–∏");
          return;
        }

        const finalWeight = parseFloat(finalWeightInput.value);
        const nutrition = calculateDishNutrition();
        
        if (!nutrition) return;

        // –§–æ—Ä–º—É–ª–∞: (–≤–µ—Å –≥–æ—Ç–æ–≤–æ–≥–æ –±–ª—é–¥–∞ / –≤–µ—Å —Å—ã—Ä—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤) * —Ü–µ–ª–µ–≤—ã–µ –∫–∞–ª–æ—Ä–∏–∏
        const ratio = finalWeight / nutrition.totalWeight;
        const portionWeight = Math.round((targetCalories / nutrition.calories) * finalWeight);

        const result = {
          calories: targetCalories,
          protein: Math.round(nutrition.protein * (targetCalories / nutrition.calories) * 10) / 10,
          fat: Math.round(nutrition.fat * (targetCalories / nutrition.calories) * 10) / 10,
          carbs: Math.round(nutrition.carbs * (targetCalories / nutrition.calories) * 10) / 10,
          weight: portionWeight
        };

        displayResults(result);
      }

      function displayResults(result) {
        document.getElementById("resultCalories").textContent = result.calories;
        document.getElementById("resultProtein").textContent = result.protein + " –≥";
        document.getElementById("resultFat").textContent = result.fat + " –≥";
        document.getElementById("resultCarbs").textContent = result.carbs + " –≥";
        document.getElementById("resultWeight").textContent = result.weight + " –≥";
        calculationResult.style.display = "block";
      }

      function copyResultsToClipboard() {
        const ingredients = getIngredients();
        let text = "–°–æ—Å—Ç–∞–≤ –±–ª—é–¥–∞:\n";
        
        ingredients.forEach(ing => {
          text += `${ing.ingredient}: ${ing.displayWeight}${ing.unit}\n`;
        });

        text += `\n–ò—Ç–æ–≥–æ–≤–æ–µ –ö–ë–ñ–£:\n`;
        text += `–ö–∞–ª–æ—Ä–∏–∏: ${document.getElementById("resultCalories").textContent}\n`;
        text += `–ë–µ–ª–∫–∏: ${document.getElementById("resultProtein").textContent}\n`;
        text += `–ñ–∏—Ä—ã: ${document.getElementById("resultFat").textContent}\n`;
        text += `–£–≥–ª–µ–≤–æ–¥—ã: ${document.getElementById("resultCarbs").textContent}\n`;
        text += `–í–µ—Å –ø–æ—Ä—Ü–∏–∏: ${document.getElementById("resultWeight").textContent}`;

        navigator.clipboard.writeText(text).then(() => {
          showMessage(successMessage, "üìã –î–∞–Ω–Ω—ã–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!");
        });
      }

      function attachAutocompleteTo(inputElem) {
        if (!inputElem || inputElem._acBox) return;

        const box = document.createElement("div");
        box.className = "autocomplete-box";
        box.style.display = "none";
        inputElem.parentNode.appendChild(box);

        inputElem._acBox = box;

        function hideBox() {
          box.style.display = "none";
          box.innerHTML = "";
        }

        function showSuggestions(q) {
          box.innerHTML = "";
          if (!q || !fuse) {
            hideBox();
            return;
          }

          const results = fuse.search(q, { limit: 5 }).map(r => r.item);
          if (!results.length) {
            hideBox();
            return;
          }

          results.forEach(val => {
            const el = document.createElement("div");
            el.className = "autocomplete-item";
            el.textContent = val;
            el.addEventListener("click", () => {
              inputElem.value = val;
              hideBox();
              inputElem.dispatchEvent(new Event("input", { bubbles: true }));
              
              // –ê–≤—Ç–æ–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ "—à—Ç" –¥–ª—è —à—Ç—É—á–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
              if (pieceProducts[val.toLowerCase()]) {
                const unitSelect = inputElem.parentElement.querySelector(".unit-select");
                if (unitSelect && unitSelect.value === "–≥") {
                  unitSelect.value = "—à—Ç";
                  unitSelect.dispatchEvent(new Event('change'));
                }
              }
            });
            box.appendChild(el);
          });

          box.style.display = "block";
        }

        inputElem.addEventListener("input", function() {
          showSuggestions(this.value.trim());
        });

        document.addEventListener("click", function(e) {
          if (!box.contains(e.target) && e.target !== inputElem) {
            hideBox();
          }
        });

        inputElem.addEventListener("blur", function() {
          setTimeout(hideBox, 200);
        });
      }

      // ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======
      function init() {
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É
        if (document.querySelectorAll(".row").length === 0) {
          addRow();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        addRowBtn.addEventListener("click", () => addRow());
        calculateDishBtn.addEventListener("click", function() {
          const nutrition = calculateDishNutrition();
          if (nutrition) {
            showMessage(successMessage, 
              `üçΩÔ∏è –ö–ë–ñ–£ –±–ª—é–¥–∞: ${nutrition.calories} –∫–∫–∞–ª, –ë: ${nutrition.protein}–≥, –ñ: ${nutrition.fat}–≥, –£: ${nutrition.carbs}–≥`
            );
          }
        });

        calculatePortionBtn.addEventListener("click", calculatePortionNutrition);
        calculateWeightBtn.addEventListener("click", calculateWeightByCalories);
        copyResultsBtn.addEventListener("click", copyResultsToClipboard);

        finalWeightInput.addEventListener("input", validateForm);
        
        // Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫
        document.addEventListener("keypress", function(e) {
          if (e.key === "Enter" && e.target.classList.contains("weight")) {
            const activeElement = document.activeElement;
            const currentRow = activeElement.closest(".row");
            const isLastRow = currentRow === rowsContainer.lastElementChild;
            if (isLastRow) {
              addRow();
              setTimeout(() => {
                const newRow = rowsContainer.lastElementChild;
                const newIng = newRow.querySelector(".ing");
                if (newIng) newIng.focus();
              }, 100);
            }
          }
        });

        validateForm();
      }

      // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>